/**
 * Vulnerability Reporter - Security Findings Report Generator
 * Generates detailed HTML and Markdown reports from security scan results
 * 
 * Usage: npx ts-node src/tests/security/pentest/vuln-reporter.ts <scan-report.json>
 */

import * as fs from 'fs';
import * as path from 'path';
import securityConfig from '../config';

interface ScanResult {
    endpoint: string;
    method: string;
    vulnerability: string;
    severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'INFO';
    evidence: string;
    remediation: string;
    cwe?: string;
    owasp?: string;
    timestamp: string;
}

interface ScanReport {
    scanId: string;
    startTime: string;
    endTime: string;
    target: string;
    totalEndpoints: number;
    totalVulnerabilities: number;
    bySeverity: {
        critical: number;
        high: number;
        medium: number;
        low: number;
        info: number;
    };
    findings: ScanResult[];
}

export class VulnerabilityReporter {
    private report: ScanReport;

    constructor(report: ScanReport) {
        this.report = report;
    }

    // ============================================
    // Severity Helpers
    // ============================================
    private getSeverityColor(severity: string): string {
        const colors: Record<string, string> = {
            CRITICAL: '#dc2626',
            HIGH: '#f97316',
            MEDIUM: '#eab308',
            LOW: '#3b82f6',
            INFO: '#6b7280',
        };
        return colors[severity] || '#6b7280';
    }

    private getSeverityBadge(severity: string): string {
        const badges: Record<string, string> = {
            CRITICAL: 'ðŸ”´',
            HIGH: 'ðŸŸ ',
            MEDIUM: 'ðŸŸ¡',
            LOW: 'ðŸ”µ',
            INFO: 'âšª',
        };
        return badges[severity] || 'âšª';
    }

    // ============================================
    // Generate Markdown Report
    // ============================================
    generateMarkdownReport(): string {
        const lines: string[] = [];

        lines.push('# ðŸ”’ Security Scan Report');
        lines.push('');
        lines.push('## Executive Summary');
        lines.push('');
        lines.push(`| Scan ID | ${this.report.scanId} |`);
        lines.push('|---------|----------------------|');
        lines.push(`| Target | ${this.report.target} |`);
        lines.push(`| Scan Time | ${this.report.startTime} |`);
        lines.push(`| Total Findings | ${this.report.totalVulnerabilities} |`);
        lines.push('');

        // Severity Summary
        lines.push('## Vulnerability Summary');
        lines.push('');
        lines.push('| Severity | Count |');
        lines.push('|----------|-------|');
        lines.push(`| ðŸ”´ Critical | ${this.report.bySeverity.critical} |`);
        lines.push(`| ðŸŸ  High | ${this.report.bySeverity.high} |`);
        lines.push(`| ðŸŸ¡ Medium | ${this.report.bySeverity.medium} |`);
        lines.push(`| ðŸ”µ Low | ${this.report.bySeverity.low} |`);
        lines.push(`| âšª Info | ${this.report.bySeverity.info} |`);
        lines.push('');

        // Risk Rating
        const riskRating = this.calculateRiskRating();
        lines.push('## Overall Risk Rating');
        lines.push('');
        lines.push(`**${riskRating.rating}** - ${riskRating.description}`);
        lines.push('');

        // Findings by Severity
        const severityOrder: Array<'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'INFO'> = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO'];

        for (const severity of severityOrder) {
            const findings = this.report.findings.filter(f => f.severity === severity);
            if (findings.length === 0) continue;

            lines.push(`## ${this.getSeverityBadge(severity)} ${severity} Findings (${findings.length})`);
            lines.push('');

            for (let i = 0; i < findings.length; i++) {
                const finding = findings[i];
                lines.push(`### ${i + 1}. ${finding.vulnerability}`);
                lines.push('');
                lines.push(`**Endpoint:** \`${finding.method} ${finding.endpoint}\``);
                lines.push('');
                lines.push(`**Evidence:**`);
                lines.push('```');
                lines.push(finding.evidence);
                lines.push('```');
                lines.push('');
                lines.push(`**Remediation:**`);
                lines.push(`> ${finding.remediation}`);
                lines.push('');

                if (finding.cwe || finding.owasp) {
                    lines.push('**References:**');
                    if (finding.cwe) lines.push(`- [${finding.cwe}](https://cwe.mitre.org/data/definitions/${finding.cwe.replace('CWE-', '')}.html)`);
                    if (finding.owasp) lines.push(`- OWASP: ${finding.owasp}`);
                    lines.push('');
                }

                lines.push('---');
                lines.push('');
            }
        }

        // Recommendations
        lines.push('## Recommendations');
        lines.push('');
        lines.push(this.generateRecommendations());
        lines.push('');

        // Disclaimer
        lines.push('## Disclaimer');
        lines.push('');
        lines.push('This security scan was performed in a test environment. Results may vary in production.');
        lines.push('All vulnerabilities should be verified and prioritized based on actual risk to the organization.');
        lines.push('');
        lines.push(`*Report generated at ${new Date().toISOString()}*`);

        return lines.join('\n');
    }

    // ============================================
    // Generate HTML Report
    // ============================================
    generateHtmlReport(): string {
        const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Scan Report - ${this.report.scanId}</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6; 
            color: #1f2937;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        .header h1 { font-size: 2rem; margin-bottom: 1rem; }
        .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .meta-item { background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; }
        .meta-label { font-size: 0.875rem; opacity: 0.8; }
        .meta-value { font-size: 1.25rem; font-weight: 600; }
        .severity-cards {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .severity-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }
        .severity-card.critical { border-left-color: #dc2626; }
        .severity-card.high { border-left-color: #f97316; }
        .severity-card.medium { border-left-color: #eab308; }
        .severity-card.low { border-left-color: #3b82f6; }
        .severity-card.info { border-left-color: #6b7280; }
        .severity-count { font-size: 2.5rem; font-weight: 700; }
        .severity-label { font-size: 0.875rem; color: #6b7280; text-transform: uppercase; }
        .findings-section { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; }
        .section-title { font-size: 1.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        .finding {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .finding-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f9fafb;
            cursor: pointer;
        }
        .finding-title { font-weight: 600; }
        .finding-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }
        .badge-critical { background: #dc2626; }
        .badge-high { background: #f97316; }
        .badge-medium { background: #eab308; color: #1f2937; }
        .badge-low { background: #3b82f6; }
        .badge-info { background: #6b7280; }
        .finding-body { padding: 1.5rem; display: none; }
        .finding.open .finding-body { display: block; }
        .finding-detail { margin-bottom: 1rem; }
        .detail-label { font-weight: 600; color: #374151; margin-bottom: 0.25rem; }
        .detail-value { background: #f3f4f6; padding: 0.75rem; border-radius: 6px; font-family: monospace; }
        .remediation { 
            background: #ecfdf5; 
            border-left: 4px solid #10b981; 
            padding: 1rem; 
            border-radius: 0 8px 8px 0; 
        }
        .risk-meter {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        .risk-bar {
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .risk-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
        }
        @media print {
            .container { padding: 0; }
            .finding-body { display: block !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”’ Security Scan Report</h1>
            <div class="meta-grid">
                <div class="meta-item">
                    <div class="meta-label">Scan ID</div>
                    <div class="meta-value">${this.report.scanId}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Target</div>
                    <div class="meta-value">${this.report.target}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Scan Time</div>
                    <div class="meta-value">${new Date(this.report.startTime).toLocaleString()}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Total Findings</div>
                    <div class="meta-value">${this.report.totalVulnerabilities}</div>
                </div>
            </div>
        </div>

        <div class="severity-cards">
            <div class="severity-card critical">
                <div class="severity-count">${this.report.bySeverity.critical}</div>
                <div class="severity-label">Critical</div>
            </div>
            <div class="severity-card high">
                <div class="severity-count">${this.report.bySeverity.high}</div>
                <div class="severity-label">High</div>
            </div>
            <div class="severity-card medium">
                <div class="severity-count">${this.report.bySeverity.medium}</div>
                <div class="severity-label">Medium</div>
            </div>
            <div class="severity-card low">
                <div class="severity-count">${this.report.bySeverity.low}</div>
                <div class="severity-label">Low</div>
            </div>
            <div class="severity-card info">
                <div class="severity-count">${this.report.bySeverity.info}</div>
                <div class="severity-label">Info</div>
            </div>
        </div>

        <div class="risk-meter">
            <h2>Overall Risk Rating: ${this.calculateRiskRating().rating}</h2>
            <p>${this.calculateRiskRating().description}</p>
            <div class="risk-bar">
                <div class="risk-fill" style="width: ${this.calculateRiskRating().percentage}%; background: ${this.calculateRiskRating().color};"></div>
            </div>
        </div>

        <div class="findings-section">
            <h2 class="section-title">Vulnerability Details</h2>
            ${this.generateFindingsHtml()}
        </div>

        <div class="findings-section">
            <h2 class="section-title">Recommendations</h2>
            ${this.generateRecommendationsHtml()}
        </div>
    </div>

    <script>
        document.querySelectorAll('.finding-header').forEach(header => {
            header.addEventListener('click', () => {
                header.parentElement.classList.toggle('open');
            });
        });
    </script>
</body>
</html>`;

        return html;
    }

    // ============================================
    // Helper Methods
    // ============================================
    private generateFindingsHtml(): string {
        if (this.report.findings.length === 0) {
            return '<p>No vulnerabilities found! ðŸŽ‰</p>';
        }

        return this.report.findings.map(finding => `
            <div class="finding">
                <div class="finding-header">
                    <span class="finding-title">${finding.vulnerability}</span>
                    <span class="finding-badge badge-${finding.severity.toLowerCase()}">${finding.severity}</span>
                </div>
                <div class="finding-body">
                    <div class="finding-detail">
                        <div class="detail-label">Endpoint</div>
                        <div class="detail-value">${finding.method} ${finding.endpoint}</div>
                    </div>
                    <div class="finding-detail">
                        <div class="detail-label">Evidence</div>
                        <div class="detail-value">${finding.evidence}</div>
                    </div>
                    <div class="remediation">
                        <div class="detail-label">Remediation</div>
                        <p>${finding.remediation}</p>
                    </div>
                    ${finding.cwe || finding.owasp ? `
                    <div class="finding-detail" style="margin-top: 1rem;">
                        <div class="detail-label">References</div>
                        <p>${finding.cwe ? `<a href="https://cwe.mitre.org/data/definitions/${finding.cwe.replace('CWE-', '')}.html" target="_blank">${finding.cwe}</a>` : ''} ${finding.owasp || ''}</p>
                    </div>
                    ` : ''}
                </div>
            </div>
        `).join('');
    }

    private generateRecommendationsHtml(): string {
        const recommendations = this.generateRecommendations().split('\n');
        return `<ul>${recommendations.map(r => r.trim()).filter(r => r.startsWith('-')).map(r => `<li>${r.substring(2)}</li>`).join('')}</ul>`;
    }

    private calculateRiskRating(): { rating: string; description: string; percentage: number; color: string } {
        const { critical, high, medium, low } = this.report.bySeverity;
        const score = critical * 10 + high * 5 + medium * 2 + low * 1;

        if (critical > 0 || score >= 20) {
            return { rating: 'CRITICAL', description: 'Immediate action required. Critical vulnerabilities found.', percentage: 100, color: '#dc2626' };
        } else if (high > 0 || score >= 10) {
            return { rating: 'HIGH', description: 'High priority. Address high severity issues promptly.', percentage: 75, color: '#f97316' };
        } else if (medium > 0 || score >= 5) {
            return { rating: 'MEDIUM', description: 'Moderate risk. Plan remediation for medium issues.', percentage: 50, color: '#eab308' };
        } else if (low > 0) {
            return { rating: 'LOW', description: 'Low risk. Review and address as part of maintenance.', percentage: 25, color: '#3b82f6' };
        }
        return { rating: 'SECURE', description: 'No significant vulnerabilities detected. Maintain security practices.', percentage: 5, color: '#10b981' };
    }

    private generateRecommendations(): string {
        const recommendations: string[] = [];
        const { critical, high, medium } = this.report.bySeverity;

        if (critical > 0) {
            recommendations.push('- **URGENT:** Address all critical vulnerabilities immediately before deployment.');
            recommendations.push('- Conduct a code review focusing on authentication and authorization logic.');
        }

        if (high > 0) {
            recommendations.push('- Prioritize high severity issues for the next sprint.');
            recommendations.push('- Implement security testing in CI/CD pipeline.');
        }

        if (medium > 0) {
            recommendations.push('- Plan remediation for medium issues within 30 days.');
            recommendations.push('- Review security headers configuration with Helmet.js.');
        }

        // General recommendations
        recommendations.push('- Enable comprehensive logging for security events.');
        recommendations.push('- Implement regular security scans (weekly recommended).');
        recommendations.push('- Train development team on secure coding practices.');
        recommendations.push('- Keep all dependencies up to date.');

        return recommendations.join('\n');
    }

    // ============================================
    // Save Reports
    // ============================================
    saveReports(outputDir?: string): { markdown: string; html: string } {
        const dir = outputDir || securityConfig.reporting.outputDir;
        if (!fs.existsSync(dir)) {
            fs.mkdirSync(dir, { recursive: true });
        }

        const baseName = `security-report-${this.report.scanId}`;
        const mdPath = path.join(dir, `${baseName}.md`);
        const htmlPath = path.join(dir, `${baseName}.html`);

        fs.writeFileSync(mdPath, this.generateMarkdownReport());
        fs.writeFileSync(htmlPath, this.generateHtmlReport());

        console.log(`ðŸ“„ Markdown report saved: ${mdPath}`);
        console.log(`ðŸ“„ HTML report saved: ${htmlPath}`);

        return { markdown: mdPath, html: htmlPath };
    }
}

// ============================================
// CLI Runner
// ============================================
if (require.main === module) {
    const args = process.argv.slice(2);

    if (args.length === 0) {
        console.log('Usage: npx ts-node vuln-reporter.ts <scan-report.json>');
        process.exit(1);
    }

    const reportPath = args[0];

    if (!fs.existsSync(reportPath)) {
        console.error(`Report file not found: ${reportPath}`);
        process.exit(1);
    }

    const reportData = JSON.parse(fs.readFileSync(reportPath, 'utf-8'));
    const reporter = new VulnerabilityReporter(reportData);
    reporter.saveReports();
}
